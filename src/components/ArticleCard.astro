---
/**
 * æ–‡ç« å¡ç‰‡ç»„ä»¶
 * ç®€çº¦æ´»æ³¼é£æ ¼ï¼Œé…åˆå››è‰²ç³»ä¸»é¢˜
 */
import TagList from './TagList.astro';

interface Props {
  title: string;
  description?: string;
  date: Date;
  tags?: string[];
  href: string;
  cover?: string;
  template?: string;
}

const { title, description, date, tags = [], href, cover, template = 'note' } = Astro.props as Props;

// ç»Ÿä¸€å°é¢å›¾è·¯å¾„ï¼š
// - æœ¬åœ°å¼€å‘ï¼šBASE_URL é€šå¸¸ä¸º "/"ï¼Œä¿æŒåŸæœ‰æ•ˆæœ
// - ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚ GitHub Pages å­è·¯å¾„ /ai-flow4pm/ï¼‰ï¼šè‡ªåŠ¨è¡¥å…¨ BASE_URLï¼Œé¿å… 404
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl.endsWith('/') ? rawBaseUrl : `${rawBaseUrl}/`;

const resolveCover = (path?: string) => {
  if (!path) return undefined;

  // å¤–é“¾å›¾ç‰‡ä¿æŒåŸæ ·
  if (/^https?:\/\//.test(path)) return path;

  // å»æ‰å¼€å¤´çš„ "/"ï¼Œé¿å…å‡ºç° "//img/..." è¿™ç±»è·¯å¾„
  const normalized = path.startsWith('/') ? path.slice(1) : path;

  // ä½¿ç”¨ BASE_URL + ç›¸å¯¹è·¯å¾„ï¼Œå…¼å®¹æœ¬åœ°å’Œå­è·¯å¾„éƒ¨ç½²
  return `${baseUrl}${normalized}`;
};

const resolvedCover = resolveCover(cover);

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (d: Date) => {
  return new Date(d).toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// æ¨¡æ¿ç±»å‹é…ç½®ï¼šä½œå“(é»„è‰²)ã€æ•™ç¨‹(è“è‰²)ã€ç¬”è®°(ç»¿è‰²)
const templateConfig: Record<string, { label: string; icon: string; color: string }> = {
  work: { 
    label: 'ä½œå“', 
    icon: 'ğŸ¨', 
    color: 'var(--color-yellow)',
  },
  tutorial: { 
    label: 'æ•™ç¨‹', 
    icon: 'ğŸ“š', 
    color: 'var(--color-blue)',
  },
  note: { 
    label: 'ç¬”è®°', 
    icon: 'ğŸ“', 
    color: 'var(--color-green)',
  },
};

const currentTemplate = templateConfig[template] || templateConfig.note;
---

<article class="article-card group bg-white rounded-2xl transition-all duration-300">
  <a href={href} class="block">
    <!-- å°é¢åŒºåŸŸ -->
    {resolvedCover ? (
      <div class="h-44 overflow-hidden rounded-t-2xl">
        <img 
          src={resolvedCover} 
          alt={title} 
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
          loading="lazy"
        />
      </div>
    ) : (
      <div 
        class="h-36 flex items-center justify-center relative overflow-hidden rounded-t-2xl"
        style={`background: linear-gradient(135deg, ${currentTemplate.color}12 0%, ${currentTemplate.color}25 100%)`}
      >
        <!-- è£…é¥°åœ†å½¢ -->
        <div 
          class="absolute -right-8 -top-8 w-28 h-28 rounded-full opacity-25 transition-transform duration-300 group-hover:scale-110"
          style={`background: ${currentTemplate.color}`}
        ></div>
        <div 
          class="absolute -left-4 -bottom-4 w-16 h-16 rounded-full opacity-15"
          style={`background: ${currentTemplate.color}`}
        ></div>
        <span class="text-5xl relative z-10 transition-transform duration-300 group-hover:scale-110">{currentTemplate.icon}</span>
      </div>
    )}
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="p-5">
      <!-- ç±»å‹å’Œæ—¥æœŸ -->
      <div class="flex items-center gap-3 text-xs text-[var(--color-text-muted)] mb-3">
        <span 
          class="px-2.5 py-1 rounded-full font-medium"
          style={`background: ${currentTemplate.color}15; color: ${currentTemplate.color}`}
        >
          {currentTemplate.icon} {currentTemplate.label}
        </span>
        <time datetime={date.toISOString()} class="text-[var(--color-text-muted)]">
          {formatDate(date)}
        </time>
      </div>
      
      <!-- æ ‡é¢˜ -->
      <h3 class="text-lg font-semibold text-[var(--color-text)] mb-2 line-clamp-2 group-hover:text-[var(--color-primary)] transition-colors leading-snug">
        {title}
      </h3>
      
      <!-- æè¿° -->
      {description && (
        <p class="text-[var(--color-text-muted)] text-sm line-clamp-2 leading-relaxed">
          {description}
        </p>
      )}
      
      <!-- æ ‡ç­¾ -->
      {tags.length > 0 && (
        <div class="mt-3 pt-3 border-t border-gray-100" onclick="event.stopPropagation()">
          <TagList tags={tags.slice(0, 3)} size="sm" />
        </div>
      )}
    </div>
  </a>
</article>

<style>
  .article-card {
    display: flex;
    flex-direction: column;
    /* è®©å¡ç‰‡åœ¨ç½‘æ ¼ä¸­æ’‘æ»¡çˆ¶å…ƒç´ é«˜åº¦ï¼Œä¿è¯åŒä¸€è¡Œå†…å¡ç‰‡é«˜åº¦ä¸€è‡´ */
    height: 100%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  }
  
  .article-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.1);
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
