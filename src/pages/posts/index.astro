---
/**
 * æ–‡ç« åˆ—è¡¨é¡µ
 * æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ï¼ˆtutorialsã€notesï¼‰ï¼Œæ”¯æŒæŒ‰ç±»å‹å’Œæ ‡ç­¾ç­›é€‰
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// è·å–æ‰€æœ‰é›†åˆçš„å†…å®¹
const works = await getCollection('works', ({ data }: CollectionEntry<'works'>) => !data.draft);
const tutorials = await getCollection('tutorials', ({ data }: CollectionEntry<'tutorials'>) => !data.draft);
const notes = await getCollection('notes', ({ data }: CollectionEntry<'notes'>) => !data.draft);

// å®šä¹‰ç»Ÿä¸€çš„æ–‡ç« ç±»å‹
type Article = {
  id: string;
  collection: string;
  data: {
    title: string;
    description?: string;
    date: Date;
    tags?: string[];
    cover?: string;
    template?: string;
  };
};

// åˆå¹¶æ‰€æœ‰å†…å®¹å¹¶æŒ‰æ—¥æœŸæ’åº
const allArticles: Article[] = [
  ...works.map((w: CollectionEntry<'works'>) => ({ ...w, collection: 'works' })),
  ...tutorials.map((t: CollectionEntry<'tutorials'>) => ({ ...t, collection: 'tutorials' })),
  ...notes.map((n: CollectionEntry<'notes'>) => ({ ...n, collection: 'notes' })),
].sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// ç¡®ä¿ baseUrl ä»¥æ–œæ ç»“å°¾
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl.endsWith('/') ? rawBaseUrl : `${rawBaseUrl}/`;

// ç»Ÿè®¡å„ç±»å‹æ–‡ç« æ•°é‡
const workCount = allArticles.filter(p => p.data.template === 'work').length;
const tutorialCount = allArticles.filter(p => p.data.template === 'tutorial').length;
const noteCount = allArticles.filter(p => p.data.template === 'note' || !p.data.template).length;

// æ”¶é›†æ‰€æœ‰å”¯ä¸€æ ‡ç­¾å¹¶ç»Ÿè®¡æ•°é‡
const tagCounts: Record<string, number> = {};
allArticles.forEach(article => {
  const tags = article.data.tags || [];
  tags.forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});
// æŒ‰æ–‡ç« æ•°é‡æ’åº
const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

// é¢åŒ…å±‘å¯¼èˆª
const breadcrumbItems = [
  { label: 'é¦–é¡µ', href: baseUrl },
  { label: 'æ–‡ç« ' },
];
---

<BaseLayout title="æ–‡ç« " description="æ‰€æœ‰åšå®¢æ–‡ç« åˆ—è¡¨">
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <Breadcrumb items={breadcrumbItems} />
    
    <!-- é¡µé¢æ ‡é¢˜ -->
    <header class="mb-8 text-center">
      <p class="text-xl text-[var(--color-text-secondary)]">
        å…± <span id="article-count">{allArticles.length}</span> ç¯‡æ–‡ç« 
      </p>
    </header>

    <!-- ç­›é€‰æŒ‰é’® -->
    <div class="flex flex-wrap justify-center items-center gap-3 mb-10">
      <button 
        class="filter-btn active px-5 py-2.5 rounded-full font-medium text-sm transition-all"
        data-filter="all"
        style="--btn-color: var(--color-orange);"
      >
        å…¨éƒ¨ <span class="opacity-70">({allArticles.length})</span>
      </button>
      <button 
        class="filter-btn px-5 py-2.5 rounded-full font-medium text-sm transition-all"
        data-filter="work"
        style="--btn-color: var(--color-yellow);"
      >
        ğŸ¨ ä½œå“ <span class="opacity-70">({workCount})</span>
      </button>
      <button 
        class="filter-btn px-5 py-2.5 rounded-full font-medium text-sm transition-all"
        data-filter="tutorial"
        style="--btn-color: var(--color-blue);"
      >
        ğŸ“š æ•™ç¨‹ <span class="opacity-70">({tutorialCount})</span>
      </button>
      <button 
        class="filter-btn px-5 py-2.5 rounded-full font-medium text-sm transition-all"
        data-filter="note"
        style="--btn-color: var(--color-green);"
      >
        ğŸ“ ç¬”è®° <span class="opacity-70">({noteCount})</span>
      </button>

      <!-- æ ‡ç­¾ä¸‹æ‹‰ç­›é€‰å™¨ -->
      <div class="tag-dropdown relative">
        <button 
          id="tag-dropdown-btn"
          class="tag-dropdown-btn px-5 py-2.5 rounded-full font-medium text-sm transition-all flex items-center gap-2"
          style="--btn-color: var(--color-primary);"
        >
          <span>ğŸ·ï¸ æ ‡ç­¾</span>
          <span id="selected-tag-name" class="opacity-70">å…¨éƒ¨</span>
          <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="tag-dropdown-menu" class="tag-dropdown-menu hidden absolute top-full right-0 mt-2 w-48 max-h-64 overflow-y-auto bg-white rounded-xl shadow-lg border border-[var(--color-border)] z-50">
          <button 
            class="tag-option w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 transition-colors first:rounded-t-xl"
            data-tag=""
          >
            å…¨éƒ¨æ ‡ç­¾
          </button>
          {sortedTags.map(([tag, count], index) => (
            <button 
              class={`tag-option w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 transition-colors ${index === sortedTags.length - 1 ? 'last:rounded-b-xl' : ''}`}
              data-tag={tag}
            >
              #{tag} <span class="text-[var(--color-text-muted)]">({count})</span>
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    {allArticles.length > 0 ? (
      <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allArticles.map((article) => (
          <div 
            class="article-item" 
            data-template={article.data.template || 'note'}
            data-tags={JSON.stringify(article.data.tags || [])}
          >
            <ArticleCard 
              title={article.data.title}
              description={article.data.description}
              date={article.data.date}
              tags={article.data.tags}
              href={`${baseUrl}posts/${article.id}`}
              cover={article.data.cover}
              template={article.data.template}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-16 bg-[var(--color-bg-secondary)] rounded-xl border border-[var(--color-border)]">
        <p class="text-[var(--color-text-muted)] text-lg">
          æš‚æ— æ–‡ç« 
        </p>
        <p class="text-[var(--color-text-muted)] mt-2">
          åœ¨ <code class="bg-[var(--color-bg-card)] px-2 py-1 rounded">src/content/posts/</code> ç›®å½•ä¸‹åˆ›å»º Markdown æ–‡ä»¶
        </p>
      </div>
    )}

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="empty-state" class="hidden text-center py-16">
      <p class="text-[var(--color-text-muted)] text-lg">
        è¯¥åˆ†ç±»ä¸‹æš‚æ— æ–‡ç« 
      </p>
    </div>
  </div>
</BaseLayout>

<style>
  /* ç­›é€‰æŒ‰é’®æ ·å¼ */
  .filter-btn {
    background: white;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    cursor: pointer;
  }
  
  .filter-btn:hover {
    border-color: var(--btn-color);
    color: var(--btn-color);
  }
  
  .filter-btn.active {
    background: var(--btn-color);
    color: white;
    border-color: var(--btn-color);
  }

  /* æ ‡ç­¾ä¸‹æ‹‰ç­›é€‰å™¨æ ·å¼ */
  .tag-dropdown-btn {
    background: white;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    cursor: pointer;
  }

  .tag-dropdown-btn:hover {
    border-color: var(--btn-color);
    color: var(--btn-color);
  }

  /* é€‰ä¸­æ ‡ç­¾æ—¶ï¼Œåªæœ‰æ–‡å­—å˜æ©™è‰²ï¼ŒèƒŒæ™¯ä¸å˜ */
  .tag-dropdown-btn.has-selection {
    color: var(--color-text-secondary);
    border-color: var(--color-border);
  }

  .tag-dropdown-btn.has-selection #selected-tag-name {
    color: var(--color-orange);
    opacity: 1;
  }

  /* åªæœ‰å±•å¼€æ—¶ç®­å¤´æ‰å‘ä¸Š */
  .tag-dropdown-btn.open svg {
    transform: rotate(180deg);
  }

  .tag-dropdown-menu {
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .tag-dropdown-menu::-webkit-scrollbar {
    width: 6px;
  }

  .tag-dropdown-menu::-webkit-scrollbar-track {
    background: transparent;
  }

  .tag-dropdown-menu::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 3px;
  }

  .tag-option {
    border: none;
    background: none;
    cursor: pointer;
    color: var(--color-text);
  }

  .tag-option:hover {
    background: var(--color-bg-secondary);
  }

  .tag-option.selected {
    background: var(--color-primary);
    color: white;
  }

  .tag-option.selected:hover {
    background: var(--color-primary);
  }

  /* æ–‡ç« é¡¹è¿‡æ¸¡åŠ¨ç”» */
  .article-item {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .article-item.hidden {
    display: none;
  }
</style>

<script>
  // ç­›é€‰åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const filterBtns = document.querySelectorAll('.filter-btn');
    const articleItems = document.querySelectorAll('.article-item');
    const articleCount = document.getElementById('article-count');
    const emptyState = document.getElementById('empty-state');
    const articlesGrid = document.getElementById('articles-grid');

    // æ ‡ç­¾ä¸‹æ‹‰ç­›é€‰å™¨ç›¸å…³å…ƒç´ 
    const tagDropdownBtn = document.getElementById('tag-dropdown-btn');
    const tagDropdownMenu = document.getElementById('tag-dropdown-menu');
    const selectedTagName = document.getElementById('selected-tag-name');
    const tagOptions = document.querySelectorAll('.tag-option');

    // å½“å‰ç­›é€‰çŠ¶æ€
    let currentTypeFilter = 'all';
    let currentTagFilter = '';

    // ä»URLè·å–åˆå§‹æ ‡ç­¾å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const initialTag = urlParams.get('tag');
    if (initialTag) {
      currentTagFilter = decodeURIComponent(initialTag);
      if (selectedTagName) {
        selectedTagName.textContent = currentTagFilter;
      }
      // é«˜äº®å¯¹åº”çš„æ ‡ç­¾é€‰é¡¹
      tagOptions.forEach(opt => {
        const optTag = opt.getAttribute('data-tag') || '';
        if (optTag === currentTagFilter) {
          opt.classList.add('selected');
        }
      });
      // æ ‡è®°æœ‰é€‰ä¸­æ ‡ç­¾ï¼ˆé"å…¨éƒ¨"ï¼‰
      if (tagDropdownBtn && currentTagFilter) {
        tagDropdownBtn.classList.add('has-selection');
      }
    }

    // ç»Ÿä¸€çš„ç­›é€‰å‡½æ•°
    function applyFilters() {
      let visibleCount = 0;
      articleItems.forEach(item => {
        const template = item.getAttribute('data-template');
        const tagsJson = item.getAttribute('data-tags') || '[]';
        const tags = JSON.parse(tagsJson) as string[];

        // ç±»å‹ç­›é€‰
        const typeMatch = currentTypeFilter === 'all' || template === currentTypeFilter;
        // æ ‡ç­¾ç­›é€‰
        const tagMatch = !currentTagFilter || tags.includes(currentTagFilter);

        const shouldShow = typeMatch && tagMatch;

        if (shouldShow) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      // æ›´æ–°è®¡æ•°
      if (articleCount) {
        articleCount.textContent = visibleCount.toString();
      }

      // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
      if (emptyState && articlesGrid) {
        if (visibleCount === 0) {
          emptyState.classList.remove('hidden');
          articlesGrid.classList.add('hidden');
        } else {
          emptyState.classList.add('hidden');
          articlesGrid.classList.remove('hidden');
        }
      }
    }

    // ç±»å‹ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentTypeFilter = btn.getAttribute('data-filter') || 'all';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        applyFilters();
      });
    });

    // æ ‡ç­¾ä¸‹æ‹‰èœå•åˆ‡æ¢
    if (tagDropdownBtn && tagDropdownMenu) {
      tagDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = tagDropdownMenu.classList.contains('hidden');
        if (isHidden) {
          tagDropdownMenu.classList.remove('hidden');
          tagDropdownBtn.classList.add('open');
        } else {
          tagDropdownMenu.classList.add('hidden');
          tagDropdownBtn.classList.remove('open');
        }
      });

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', () => {
        tagDropdownMenu.classList.add('hidden');
        tagDropdownBtn.classList.remove('open');
      });

      // é˜»æ­¢ä¸‹æ‹‰èœå•å†…éƒ¨ç‚¹å‡»å†’æ³¡
      tagDropdownMenu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // æ ‡ç­¾é€‰é¡¹ç‚¹å‡»äº‹ä»¶
    tagOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const tag = opt.getAttribute('data-tag') || '';
        currentTagFilter = tag;

        // æ›´æ–°æ˜¾ç¤ºçš„æ ‡ç­¾å
        if (selectedTagName) {
          selectedTagName.textContent = tag || 'å…¨éƒ¨';
        }

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        tagOptions.forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');

        // æ›´æ–°ä¸‹æ‹‰æŒ‰é’®çŠ¶æ€ï¼šæœ‰é€‰ä¸­æ ‡ç­¾æ—¶æ·»åŠ  has-selection ç±»
        if (tagDropdownBtn) {
          if (tag) {
            tagDropdownBtn.classList.add('has-selection');
          } else {
            tagDropdownBtn.classList.remove('has-selection');
          }
        }

        // å…³é—­ä¸‹æ‹‰èœå•å¹¶ç§»é™¤ open ç±»
        if (tagDropdownMenu) {
          tagDropdownMenu.classList.add('hidden');
        }
        if (tagDropdownBtn) {
          tagDropdownBtn.classList.remove('open');
        }

        // æ›´æ–°URLå‚æ•°
        const url = new URL(window.location.href);
        if (tag) {
          url.searchParams.set('tag', tag);
        } else {
          url.searchParams.delete('tag');
        }
        window.history.replaceState({}, '', url.toString());

        applyFilters();
      });
    });

    // åˆå§‹åŒ–ç­›é€‰ï¼ˆå¤„ç†URLå‚æ•°ï¼‰
    applyFilters();
  });
</script>

